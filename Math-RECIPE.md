# **Math-RECIPE v2.0 (ã‚¨ãƒ©ãƒ¼å¯¾å¿œå¼·åŒ–ç‰ˆ)**
**æ•°å¼PNGè‡ªå‹•ç”Ÿæˆãƒšãƒ¼ã‚¸ ãƒ¬ã‚·ãƒ”**

---

## **ğŸ“Œ ã“ã®ãƒ¬ã‚·ãƒ”ã«ã¤ã„ã¦**

ç”ŸæˆAIãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°å¼æŒ‡ç¤ºã‚’è§£é‡ˆã—ã€é«˜å“è³ªãª**æ•°å¼PNGãƒ•ã‚¡ã‚¤ãƒ«**ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã€**å˜ä¸€HTMLãƒ•ã‚¡ã‚¤ãƒ«**ã‚’è‡ªå‹•ä½œæˆã™ã‚‹ãŸã‚ã®æŒ‡ç¤ºæ›¸ã§ã™ã€‚

### **v2.0ã®å¤‰æ›´ç‚¹ (é‡è¦)**
- **ã‚¨ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½ã®æ­è¼‰**: `PPTX-RECIPE`ã‹ã‚‰é«˜æ©Ÿèƒ½ãªã‚¨ãƒ©ãƒ¼å ±å‘Šæ©Ÿèƒ½ã‚’ç§»æ¤ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è©³ç´°ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦AIã«ä¿®æ­£ã‚’ä¾é ¼ã§ãã¾ã™ã€‚
- ğŸ› **å®‰å®šæ€§ã®å‘ä¸Š**: ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã£ã¦ã„ãŸã€ä¸è¦ãªãƒ•ã‚©ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ§‹ç¯‰å‡¦ç†ã‚’å‰Šé™¤æ¸ˆã¿ã§ã™ã€‚

### **v1.9ã‹ã‚‰ã®ä¸»ãªæ©Ÿèƒ½**
- ğŸš€ **æœ€æ–°ã®å®Ÿè¡Œç’°å¢ƒ**: Pyodide `v0.28.2` ã‚’ä½¿ç”¨ã—ã€é«˜é€ŸãªåˆæœŸåŒ–ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾ã€‚
- ğŸ–‹ï¸ **ãƒ•ã‚©ãƒ³ãƒˆé¸æŠ**: 'Computer Modern', 'STIX', 'DejaVu Sans'ãªã©è¤‡æ•°ã®ãƒ•ã‚©ãƒ³ãƒˆã‹ã‚‰é¸æŠå¯èƒ½ã€‚
- ğŸ¨ **ãƒ•ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: æ–‡å­—è‰²ã€èƒŒæ™¯è‰²ã€é€æ˜åº¦ãªã©ã‚’è‡ªç”±ã«è¨­å®šã€‚

---

## **ğŸ¯ AIå®Ÿè£…ã®æ‰‹é †**

### **ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è§£é‡ˆ**

AIã¯ä»¥ä¸‹ã®æ‰‹é †ã§æ•°å¼ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ï¼š

1.  **å…¥åŠ›å½¢å¼ã®åˆ¤å®š**
    ```
    - TeXå½¢å¼ï¼ˆ\ã‚„$ã‚’å«ã‚€ï¼‰â†’ ãã®ã¾ã¾ä½¿ç”¨
    - è‡ªç„¶è¨€èª â†’ TeXå½¢å¼ã«å¤‰æ›
    - ãã®ä»–ã®æ•°å¼è¨˜æ³• â†’ TeXå½¢å¼ã«å¤‰æ›
    ```

2.  **TeXå½¢å¼ã¸ã®å¤‰æ›ä¾‹**
    ```
    å…¥åŠ›: "xã®2ä¹—ãƒ—ãƒ©ã‚¹yã®2ä¹—ã‚¤ã‚³ãƒ¼ãƒ«1"
    å¤‰æ›: x^2 + y^2 = 1
    ```

3.  **å¤‰æ›çµæœã®åŸ‹ã‚è¾¼ã¿**
    ```html
    <!-- HTMLã®ã“ã®éƒ¨åˆ†ã«å¤‰æ›çµæœã‚’æŒ¿å…¥ -->
    <textarea id="formula-input">ã“ã“ã«TeXå½¢å¼ã®æ•°å¼</textarea>
    ```

### **ã‚¹ãƒ†ãƒƒãƒ—2: HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ**

å¤‰æ›ã—ãŸTeXå½¢å¼ã‚’HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æŒ‡å®šç®‡æ‰€ã«åŸ‹ã‚è¾¼ã‚“ã§ãã ã•ã„ã€‚

---

## **ğŸš¨ å®Ÿè£…ãƒ«ãƒ¼ãƒ« (v2.0)**

### **ğŸ”´ çµ¶å¯¾ç¦æ­¢äº‹é …ï¼ˆå¤‰æ›´ãƒ»å‰Šé™¤å³ç¦ï¼‰**

1.  **Matplotlibã®ãƒ­ãƒ¼ãƒ‰**
    ```javascript
    await pyodide.loadPackage("matplotlib");
    ```

2.  **Pyodideã®ãƒ­ãƒ¼ãƒ‰**
    ```html
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    ```
3.  **ã‚¨ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®HTML/CSS/JS**
    - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®HTMLæ§‹é€  (`<div id="error-overlay">`)
    - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®CSSã‚¯ãƒ©ã‚¹ (`.error-overlay`, `.error-card`ç­‰)
    - `showError`é–¢æ•°ã‚’å«ã‚€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®JavaScriptã‚³ãƒ¼ãƒ‰

### **ğŸŸ¡ å¿…é ˆãƒ«ãƒ¼ãƒ«**

1.  **Pythonã‚³ãƒ¼ãƒ‰ã®æ˜ç¤ºçš„å®Ÿè¡Œ**
    `main`é–¢æ•°å†…ã§ã€Pyodideã®åˆæœŸåŒ–ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸ**å¾Œ**ã«ã€`<script>`ã‚¿ã‚°å†…ã®Pythonã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    ```javascript
    const pythonCode = document.getElementById('python-code').textContent;
    await pyodide.runPythonAsync(pythonCode);
    await runGeneration(true); // åˆå›å®Ÿè¡Œ
    ```

---

## **ğŸ“ HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (v2.0 ã‚¨ãƒ©ãƒ¼å¯¾å¿œå¼·åŒ–ç‰ˆ)**

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>æ•°å¼PNGã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ v2.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preview-area { min-height: 240px; background: linear-gradient(to bottom, #ffffff, #fafafa); border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); overflow: auto; position: relative; }
        .preview-area.transparent-bg { background: repeating-conic-gradient(#f3f4f6 0% 25%, transparent 0% 50%) 50% / 20px 20px; }
        .settings-section { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 20px; }
        .settings-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        
        /* ã‚¨ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (PPTX-RECIPEã‚ˆã‚Šç§»æ¤) */
        .error-overlay { position: fixed; inset: 0; background: rgba(17,24,39,0.25); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
        .error-card { width: 100%; max-width: 880px; background: rgba(255,255,255,0.96); border: 1px solid rgba(55,65,81,0.25); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); padding: 20px; }
        .error-title { display:flex; align-items:center; gap:8px; font-weight:800; font-size:18px; color:#991b1b; }
        .error-subtitle { margin-top:6px; color:#374151; line-height:1.55; }
        .error-actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .copy-btn { border:1px solid rgba(55,65,81,.3); padding:8px 12px; border-radius:10px; font-weight:600; background:#fff; cursor: pointer; }
        .copy-btn:hover { background: #f3f4f6; }
        .error-pre { margin-top:12px; background:#0b1020; color:#e5e7eb; border-radius:12px; padding:12px 14px; max-height:320px; overflow:auto; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Courier New',monospace; font-size:13px; line-height:1.45; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4">

    <div class="max-w-4xl mx-auto py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">æ•°å¼PNGã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
                <p class="text-gray-600">ç¾ã—ã„æ•°å¼ã‚’è‡ªç”±ãªè‰²å½©ã¨ãƒ•ã‚©ãƒ³ãƒˆã§PNGå½¢å¼ã«å¤‰æ›</p>
                <p class="text-xs text-gray-500 mt-2">v2.0 - Pyodide v0.28.2</p>
            </div>

            <div class="mb-6">
                <label class="block mb-2 text-sm font-semibold text-gray-700" for="formula-input">TeXå½¢å¼ã®æ•°å¼</label>
                <textarea id="formula-input" class="w-full p-3 border-2 border-gray-200 rounded-lg font-mono text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" rows="3" placeholder="ä¾‹: \int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}"></textarea>
            </div>

            <div id="status-container" class="mb-6 h-12 flex items-center justify-center">
                <p id="status-message" class="text-gray-600">æº–å‚™ã—ã¦ã„ã¾ã™...</p>
            </div>

            <div class="preview-area" id="preview-area">
                <div class="preview-placeholder">
                    <div id="loading-spinner" class="spinner mx-auto mb-4"></div>
                    <p>æ•°å¼ã‚’ç”Ÿæˆä¸­...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="regenerate-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition" disabled>âŸ³ å†ç”Ÿæˆ</button>
                <button id="download-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition" disabled>â¬‡ PNGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            
            <details class="settings-section">
                <summary class="settings-header"><span class="font-semibold text-gray-800">è©³ç´°è¨­å®š</span></summary>
                <div class="mt-4 space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2 border-b pb-2">ğŸ¨ ã‚«ãƒ©ãƒ¼è¨­å®š</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-600">æ–‡å­—è‰²</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="color" id="text-color-picker" value="#000000" class="h-8 w-8 p-0 border-0 rounded cursor-pointer">
                                    <input type="text" id="text-color" value="#000000" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">èƒŒæ™¯è‰²</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="color" id="bg-color-picker" value="#ffffff" class="h-8 w-8 p-0 border-0 rounded cursor-pointer">
                                    <input type="text" id="bg-color" value="#ffffff" class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm font-mono">
                                </div>
                            </div>
                        </div>
                         <div class="flex items-center gap-2 mt-4">
                            <input type="checkbox" id="transparent-bg" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="transparent-bg" class="text-sm text-gray-700">èƒŒæ™¯ã‚’é€æ˜ã«ã™ã‚‹</label>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-semibold text-gray-700 mb-2 border-b pb-2">âš™ï¸ åŸºæœ¬è¨­å®š</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                            <div>
                                <label for="font-size" class="block text-sm font-medium text-gray-600">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</label>
                                <input type="number" id="font-size" value="24" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded-md text-sm">
                            </div>
                            <div>
                                <label for="dpi" class="block text-sm font-medium text-gray-600">è§£åƒåº¦ (DPI)</label>
                                <input type="number" id="dpi" value="200" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded-md text-sm">
                            </div>
                             <div class="col-span-2">
                                <label for="font-type" class="block text-sm font-medium text-gray-600">ãƒ•ã‚©ãƒ³ãƒˆã‚¿ã‚¤ãƒ—</label>
                                <select id="font-type" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                    <option value="cm" selected>Computer Modern (ã‚»ãƒªãƒ•)</option>
                                    <option value="stix">STIX (ã‚»ãƒªãƒ•)</option>
                                    <option value="stixsans">STIX Sans (ã‚µãƒ³ã‚»ãƒªãƒ•)</option>
                                    <option value="dejavusans">DejaVu Sans (ã‚µãƒ³ã‚»ãƒªãƒ•)</option>
                                    <option value="dejavuserif">DejaVu Serif (ã‚»ãƒªãƒ•)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ã“ã“ã‹ã‚‰ç§»æ¤) -->
    <div id="error-overlay" class="error-overlay" role="dialog" aria-modal="true" aria-labelledby="error-title">
        <div class="error-card">
            <div class="error-title" id="error-title">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼šAIã®ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿®æ­£ã‚’ä¾é ¼ã—ã¦ä¸‹ã•ã„</div>
            <div class="error-subtitle">ã‚¨ãƒ©ãƒ¼ã®å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãã®ã¾ã¾AIã«æŠ•ã’ã¦ãã ã•ã„ã€‚åŸå› ã®ç‰¹å®šã¨ãƒ‘ãƒƒãƒã‚’ææ¡ˆã—ã¾ã™ã€‚</div>
            <div class="error-actions">
                <button id="copy-error" class="copy-btn" aria-label="ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹">ã‚¨ãƒ©ãƒ¼å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
                <button id="close-error" class="copy-btn" aria-label="ã“ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’é–‰ã˜ã‚‹">é–‰ã˜ã‚‹</button>
            </div>
            <pre id="error-text" class="error-pre" tabindex="0" aria-live="polite"></pre>
        </div>
    </div>
    <!-- (ã“ã“ã¾ã§ç§»æ¤) -->

    <script type="text/python" id="python-code">
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from io import BytesIO
import base64
import js

def hex_to_rgb(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) == 3: hex_color = ''.join([c*2 for c in hex_color])
    try: return tuple(int(hex_color[i:i+2], 16) / 255.0 for i in (0, 2, 4))
    except (ValueError, TypeError): return (0, 0, 0)

def create_math_png(formula, options):
    fontsize = options.get('fontsize', 24)
    dpi = options.get('dpi', 200)
    fontset = options.get('fontset', 'cm')
    text_color = options.get('text_color', '#000000')
    bg_color = options.get('bg_color', '#ffffff')
    transparent = options.get('transparent', False)

    if not formula.strip().startswith('$'):
        formula = '$' + formula + '$'
    
    plt.rcParams['mathtext.fontset'] = fontset
    plt.rcParams['font.size'] = fontsize
    
    fig_facecolor = 'none' if transparent else hex_to_rgb(bg_color)
    fig = plt.figure(figsize=(10, 2), facecolor=fig_facecolor)
    ax = fig.add_subplot(111)
    ax.set_facecolor(fig_facecolor)
    ax.axis('off')

    try:
        ax.text(0.5, 0.5, formula, ha='center', va='center', transform=ax.transAxes,
                fontsize=fontsize, color=hex_to_rgb(text_color))
    except Exception as e:
        ax.text(0.5, 0.5, f"Error: {str(e)}", ha='center', va='center', transform=ax.transAxes,
                fontsize=12, color='red')
    
    png_io = BytesIO()
    plt.savefig(png_io, format='png', dpi=dpi, bbox_inches='tight', pad_inches=0.2,
                transparent=transparent, facecolor=fig.get_facecolor())
    plt.close(fig)
    
    png_io.seek(0)
    return png_io.read()

def generate_formula():
    formula_input = js.document.getElementById('formula-input')
    formula = formula_input.value if formula_input.value else r"\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}"
    
    options = {
        'fontsize': int(js.document.getElementById('font-size').value),
        'dpi': int(js.document.getElementById('dpi').value),
        'fontset': js.document.getElementById('font-type').value,
        'text_color': js.document.getElementById('text-color').value,
        'bg_color': js.document.getElementById('bg-color').value,
        'transparent': js.document.getElementById('transparent-bg').checked
    }
    
    png_bytes = create_math_png(formula, options)
    png_base64 = base64.b64encode(png_bytes).decode('utf-8')
    
    js.png_base64_data = png_base64
    js.png_preview_src = f"data:image/png;base64,{png_base64}"
    
    return True
    </script>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    <script type="module">
        let pyodideInstance = null;
        
        const statusMessage = document.getElementById('status-message');
        const downloadButton = document.getElementById('download-button');
        const regenerateButton = document.getElementById('regenerate-button');
        const previewArea = document.getElementById('preview-area');
        
        // ã‚¨ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ELEMENTS (ã“ã“ã‹ã‚‰ç§»æ¤)
        const overlay = document.getElementById('error-overlay');
        const errorText = document.getElementById('error-text');
        const copyBtn = document.getElementById('copy-error');
        const closeBtn = document.getElementById('close-error');

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showError(error) {
            console.error("An error occurred:", error);
            try {
                const details = (error && (error.stack || error.message || String(error))) || 'Unknown error';
                errorText.textContent = details.trim();
            } catch(_) {
                errorText.textContent = 'Unknown error';
            }
            overlay.style.display = 'flex';
        }
        
        // ã‚¨ãƒ©ãƒ¼UIç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        copyBtn?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(errorText.textContent || '');
                copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                setTimeout(() => (copyBtn.textContent = 'ã‚¨ãƒ©ãƒ¼å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼'), 1200);
            } catch (_) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const r = document.createRange(); 
                r.selectNodeContents(errorText);
                const sel = window.getSelection(); 
                sel.removeAllRanges(); 
                sel.addRange(r);
            }
        });

        closeBtn?.addEventListener('click', () => { 
            overlay.style.display = 'none'; 
        });
        // (ã“ã“ã¾ã§ç§»æ¤)


        async function main() {
            try {
                statusMessage.textContent = 'å®Ÿè¡Œç’°å¢ƒã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...';
                const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.28.2/full/" });
                pyodideInstance = pyodide;

                statusMessage.textContent = 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';
                await pyodide.loadPackage("matplotlib");

                statusMessage.textContent = 'Pythoné–¢æ•°ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...';
                const pythonCode = document.getElementById('python-code').textContent;
                await pyodide.runPythonAsync(pythonCode);

                await runGeneration(true);

            } catch (error) {
                // åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ›´æ–°
                showError(error);
                statusMessage.textContent = 'åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                previewArea.innerHTML = `<p class="text-red-500">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
            }
        }
        
        async function runGeneration(isInitial = false) {
            if (!pyodideInstance) return;
            try {
                statusMessage.textContent = isInitial ? 'æ•°å¼ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...' : 'æ•°å¼ã‚’å†ç”Ÿæˆã—ã¦ã„ã¾ã™...';
                previewArea.innerHTML = `<div class="preview-placeholder"><div class="spinner mx-auto mb-4"></div><p>${statusMessage.textContent}</p></div>`;
                regenerateButton.disabled = true;
                downloadButton.disabled = true;
                
                await pyodideInstance.globals.get('generate_formula')();
                
                const previewSrc = window.png_preview_src;
                if (previewSrc) {
                    previewArea.innerHTML = `<img src="${previewSrc}" alt="ç”Ÿæˆã•ã‚ŒãŸæ•°å¼" class="max-w-full h-auto block mx-auto">`;
                } else {
                    throw new Error("PNG generation returned no data.");
                }
                
                statusMessage.textContent = 'âœ“ ç”Ÿæˆå®Œäº†';
            } catch (error) {
                // ç”Ÿæˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ›´æ–°
                showError(error);
                statusMessage.textContent = 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                previewArea.innerHTML = `<p class="text-red-500">ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            } finally {
                regenerateButton.disabled = false;
                downloadButton.disabled = false;
            }
        }

        function downloadFile(base64Data, fileName) {
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- Event Listeners Setup ---
        regenerateButton.addEventListener('click', () => runGeneration(false));
        downloadButton.addEventListener('click', () => {
            if (window.png_base64_data) {
                downloadFile(window.png_base64_data, `formula-${Date.now()}.png`);
            }
        });
        const textColorPicker = document.getElementById('text-color-picker');
        const textColorInput = document.getElementById('text-color');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const bgColorInput = document.getElementById('bg-color');
        textColorPicker.addEventListener('input', (e) => textColorInput.value = e.target.value);
        textColorInput.addEventListener('change', (e) => textColorPicker.value = e.target.value);
        bgColorPicker.addEventListener('input', (e) => bgColorInput.value = e.target.value);
        bgColorInput.addEventListener('change', (e) => bgColorPicker.value = e.target.value);

        const transparentBg = document.getElementById('transparent-bg');
        transparentBg.addEventListener('change', () => {
            previewArea.classList.toggle('transparent-bg', transparentBg.checked);
            bgColorPicker.disabled = transparentBg.checked;
            bgColorInput.disabled = transparentBg.checked;
        });

        window.onload = main;
    </script>
</body>
</html>
```

---

## **ğŸ¤– AIå®Ÿè£…ã‚¬ã‚¤ãƒ‰**

### **AIãŒã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä½¿ç”¨ã™ã‚‹æ‰‹é †**

1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°å¼ã‚’å—ã‘å–ã‚‹**
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã€Œxã®ç©åˆ†ã‚’ã‚°ãƒ©ãƒ•ã«ã—ã¦ã€ã¨ã„ã£ãŸè‡ªç„¶è¨€èªã®æŒ‡ç¤ºã‚„ã€ç›´æ¥çš„ãªTeXå½¢å¼ã®å…¥åŠ›ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

2.  **TeXå½¢å¼ã«å¤‰æ›**
    å…¥åŠ›ãŒè‡ªç„¶è¨€èªã®å ´åˆã€AIã®èƒ½åŠ›ã§é©åˆ‡ãªTeXå½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚
    -   å…¥åŠ›: `"xã®2ä¹—"` â†’ å¤‰æ›: `"x^2"`
    -   å…¥åŠ›: `"ã‚·ã‚°ãƒ k=1ã‹ã‚‰n"` â†’ å¤‰æ›: `\sum_{k=1}^{n}`

3.  **HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸ‹ã‚è¾¼ã¿**
    å¤‰æ›ã—ã¦å¾—ã‚‰ã‚ŒãŸTeXå½¢å¼ã®æ–‡å­—åˆ—ã‚’ã€ä¸Šè¨˜ã®HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã«ã‚ã‚‹`<textarea>`è¦ç´ ã®ä¸­ã«æŒ¿å…¥ã—ã¾ã™ã€‚
    ```html
    <textarea id="formula-input" ... >ã“ã“ã«å¤‰æ›ã—ãŸTeXå½¢å¼ã‚’æŒ¿å…¥</textarea>
    ```

4.  **å®Œæˆã—ãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›**
    æœ€çµ‚çš„ã«å®Œæˆã—ãŸå˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã—ã¾ã™ã€‚

---

## **ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**

MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ - è‡ªç”±ã«ä½¿ç”¨ãƒ»æ”¹å¤‰ãƒ»å†é…å¸ƒãƒ»å•†ç”¨åˆ©ç”¨å¯èƒ½
